<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <style lang="">
        * {
            margin: 0;
            padding: 0;
        }
        body {
            background: #ccc;
        }
        .video {
            /*background: #444;*/
            text-align: center;
            position: relative
        }
        #video {
            margin:0 auto;
            cursor: pointer;
        }
        .play, .stop {
            border: 1px solid #fff;
            display: inline-block;
            padding: 3px 5px;
            cursor: pointer;
            color: #fff;
            position: absolute;
            bottom: 10px;
        }
    </style>

    <script src="comment.js"></script>

    <script>
        window.onload = function () {
            var video = $('video');
            var allComments;

            var width = video.offsetWidth;
            var height = video.offsetHeight - 30;

            var isPlaying = false;

            // var ws = new WebSocket('ws://localhost:3000');
            var ws = new WebSocket('ws://192.168.31.248:3000');

            ws.onopen = function (){
                console.info('connection build successful');
            }

            ws.onmessage = function ( res ) {
                if ( res.data ) {
                    var data = JSON.parse(res.data);
                    if ( Array.isArray(data) ) {
                        allComments = data;
                        console.log(data);
                    } else {
                        cm.send(data);
                    }
                }
            }

            video.onseeked = function (){
                cm.clean();
            }
        
            //  检测当前视频播放进度
            function nowTime () {
                var time = null;
                video.ontimeupdate = function (){
                    var currentTime = Math.round(video.currentTime);
                    $('duration').innerHTML = currentTime + '/' + Math.round(video.duration);
                    if ( time !== currentTime && Array.isArray(allComments) ) {
                        time = currentTime;
                        for ( var i = 0; i < allComments.length; i++ ) {
                            if ( currentTime == allComments[i].time ) {
                                cm.send(allComments[i]);
                            }
                        }
                    }
                }
            }

            var cm = new CommentManager();
            cm.init({
                fontSize: 24,
                color: 'yellow',
                duration: '5',
                left: video.offsetLeft,
                top: video.offsetTop,
                width: width,
                height: height
            });

            cm.shadowEvent('click', function (){
                if ( isPlaying ) {
                    video.pause();
                    cm.pause();
                    isPlaying = false;
                } else {
                    video.play();
                    nowTime();
                    cm.resume();
                    isPlaying = true;
                }
            });

            $('send').onclick = function () {
                
                var comment_color = ['red', 'blue', 'yellow', 'green', 'orange', 'white'][Math.floor(Math.random()*6)]
                var fontSize = 24;
                var currentTime = $('video').currentTime;

                var comment_text;
                if ( $('commentInput').value ) {
                    comment_text = $('commentInput').value;
                } else {
                    comment_text = [
                        '前方高能预警',
                        '请非战斗人员撤离',
                        '前方臀控',
                        '说XX福利出来，我不打死你',
                        '说XXX的憋走，带我一个',
                        '这是一个有味道的视频',
                        '这是一个有味道的视频或隔着屏幕我都闻到了味道',
                        '看得我尴尬症都犯了',
                        '隔壁XXX过来的',
                        '打卡',
                        '这不科学',
                        '如果XXX就是神作了',
                        '6666',
                        '233333333333',
                        'XXX俺嫁或者XXX嫁我和XXX是我的或除了XXX都给你或XXX是我的或XXX在我床',
                        '请收下我（一年份）的膝盖或给跪了'
                    ][Math.floor(Math.random()*16)]
                }
                

                var data = {
                    fontSize:fontSize,
                    text: comment_text,
                    color: comment_color,
                    time: Math.round(currentTime)
                }

                cm.send(data);
                wsSend(data);
            }

            function wsSend ( data ) {
                ws.send(JSON.stringify(data));
            }

            function $ ( id ) {
                return document.getElementById(id);
            }
        }
    </script>
</head>
<body>
    <div class="video">
        <video id="video" src="oceans.mp4" controls loop width="600" height="250"></video>
    </div>
    <hr>
    <input id="commentInput" type="text" placeholder="弹幕内容" value="">
    <select name="" id="comment_color">
        <option value="#fff">白色</option>
        <option value="green">绿色</option>
        <option value="red">红色</option>
    </select>

    <button id="send">send</button>
    <button id="pause">pause</button>
    <button id="resume">resume</button>
    <button id="auto">auto</button>
    <span id="duration"></span>
</body>
</html>