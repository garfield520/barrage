<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <style lang="">
        .demo {
            width: 100px;
            height: 100px;
            position: absolute;
            left: 700px;
            color:#000;
            font-weight: bold;
            font-size: 25px;
            /* transform: translateX(-100px);    */
        }
        button {
            position: absolute;
        }
        #run {
            left: 30px;
        }
        #stop {
            left: 90px;
        }
        #continue {
            left: 150px;
        }
        .testDiv {
            white-space: nowrap;
            height: 100px;
            position: absolute;
        }
        .cbox {
            width: 500px;
            height: 300px;
            background: #ccc;
            margin:0 auto;
            position: relative;
            overflow: hidden
        }
    </style>
</head>
<body>
    <!-- <div class="demo" id="demo">来啊</div> -->
    <div id="cbox" class="cbox"></div>
    <button id="run">run</button>
    <button id="stop">stop</button>
    <button id="continue">continue</button>

    <script>
        
        var timerId = 0;

        function cacelAnimate ( id ) {
            cancelAnimationFrame( id );
        }
        
        function animate ( elem, toDestance, config ) {
            var isFirstTime = true;
            //  动画开始时间点
            var startTime = 0;
            //  时间间隔
            var timeInterval = 0;
            //  上次一帧动画执行时间点
            var lastTime = 0;
            //  每帧动画运动步长
            var step = 0;
            //  总距离
            var totalDistance = 0;
            //  总时间(ms)
            var totalTime = config.duration;
            //  当前位置
            var currentPosition = 0;
            //  方向
            var directive = '';
            //  经过的距离
            var passedDistance = 0;
            //  经过的时间
            var passedTime = 0;
            
            var currentTransform = getComputedStyle(elem).transform;
            if ( currentTransform == 'none' ) {
                totalDistance = parseFloat(toDestance);
            } else {
                currentPosition = parseFloat(currentTransform.substring(10, currentTransform.length - 1).split(',')[3]);
                totalDistance = parseFloat(toDestance) - currentPosition;
            }
            if ( totalDistance <= 0 ) {
                directive = '-';
            }
            
            // console.log('总距离：' + totalDistance);
            // console.log('总时间：' + totalTime);

            requestAnimationFrame( _loop );

            function _loop ( t ) {
                if ( isFirstTime ) {
                    startTime = lastTime = t;
                    isFirstTime = false;
                    requestAnimationFrame( _loop );
                } else {
                    //  每帧动画时间间隔
                    timeInterval = t - lastTime;
                    //  记录本帧动画执行时间点
                    lastTime = t;

                    step = totalDistance / totalTime * timeInterval;
                    currentPosition += step;
                    passedDistance += step;
                    passedTime = t - startTime;
                    
                    elem.style.transform = 'translateX(' + currentPosition +'px)';

                    config.progress( passedTime, Math.abs(passedDistance) );

                    if ( Math.abs(passedDistance) < Math.abs(totalDistance) ) {
                        timerId = requestAnimationFrame(_loop)
                    } else {
                        currentPosition = totalDistance;
                        elem.style.transform = 'translateX(' + toDestance +'px)';
                        config.complete();
                    }
                }
            }
        }

        //================================================
        
        var demo = document.getElementById('demo');
        var runBtn = document.getElementById('run');
        var stopBtn = document.getElementById('stop');
        var continueBtn = document.getElementById('continue');

        

        runBtn.onclick = function () {

            var oDiv = document.createElement('div');
            oDiv.innerHTML = [
                '前方高能预警',
                '请非战斗人员撤离',
                '前方臀控',
                '说XX福利出来，我不打死你',
                '说XXX的憋走，带我一个',
                '这是一个有味道的视频',
                '这是一个有味道的视频或隔着屏幕我都闻到了味道',
                '看得我尴尬症都犯了',
                '隔壁XXX过来的',
                '打卡',
                '这不科学',
                '如果XXX就是神作了',
                '6666',
                '233333333333',
                'XXX俺嫁或者XXX嫁我和XXX是我的或除了XXX都给你或XXX是我的或XXX在我床',
                '请收下我（一年份）的膝盖或给跪了'
            ][Math.floor(Math.random()*16)];
            oDiv.className = 'testDiv';
            oDiv.style.left = 500 + 'px';
            oDiv.style.top = Math.round(Math.random() * 300) + 'px';
            document.getElementById('cbox').appendChild(oDiv);


            oDiv.duration = 5000;
            oDiv.destination = -500 + (-oDiv.offsetWidth);
            // oDiv.passedTime = 0;
            // oDiv.passedDistance = 0;

            animate(oDiv, oDiv.destination, {
                duration: oDiv.duration,
                progress: function ( _passedTime, _passedDistance ) {
                    oDiv.passedTime = _passedTime;
                },
                complete: function () {
                    console.log('animation ended')
                }
            });

            return;
            var duration = 5000;
            var destination = -692;
            var passedTime = 0;
            var passedDistance = 0;

            var totalTime = duration;
            
            animate(demo, destination, {
                duration: duration,
                progress: function ( _passedTime, _passedDistance ) {
                    passedTime = _passedTime;
                },
                complete: function () {
                    console.log('animation ended')
                }
            });

            stopBtn.onclick = function () {
                cacelAnimate(timerId);
            }
            
            continueBtn.onclick = function () {
                totalTime = totalTime - passedTime;
                animate(demo, destination, {
                    duration: totalTime,
                    progress: function ( _passedTime, _passedDistance ) {
                        passedTime = _passedTime;
                    },
                    complete: function () {
                        console.log('animation ended')
                    }
                });
            }
        }

        

    </script>
</body>
</html>